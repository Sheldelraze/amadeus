<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.minh.nguyen.mapper.ProblemMapper">
    <select id="getAllProblem" resultMap="problem">
        SELECT
            problem.difficulty  AS dif,
            problem.isPublished AS pub,
            problem.id          AS pmId,
            problem.code        AS pmCe,
            problem.name        AS pmNe,
            tag.name            AS tgNe,
            tag.id              AS tgId
        FROM
            problem
            LEFT JOIN pm_tg
                ON pm_tg.pmId = problem.id
                   AND pm_tg.deleteFlg = '0'
            LEFT JOIN tag
                ON tag.id = pm_tg.tgId
                   AND tag.deleteFlg = '0'
        WHERE problem.deleteFlg = '0'
    </select>
    <select id="getProblemForContest" resultMap="problem">
        SELECT
            problem.difficulty  AS dif,
            problem.isPublished AS pub,
            problem.id          AS pmId,
            problem.code        AS pmCe,
            problem.name        AS pmNe,
            tag.name            AS tgNe,
            tag.id              AS tgId
        FROM
            problem
            LEFT JOIN pm_tg
                ON pm_tg.pmId = problem.id
                   AND pm_tg.deleteFlg = '0'
            LEFT JOIN tag
                ON tag.id = pm_tg.tgId
                   AND tag.deleteFlg = '0'
        WHERE problem.deleteFlg = '0'
              AND problem.id NOT IN (
            SELECT pmId
            FROM ct_pm
            WHERE ctId = #{ctId}
        )
    </select>
    <select id="getProblemToDisplay" resultType="ProblemDTO">
        SELECT
            problem.id,
            problem.name,
            problem.timeLimit,
            problem.memoryLimit,
            problem.difficulty,
            problem.solveCnt,
            ct_pm.isHidden
        FROM problem
            INNER JOIN ct_pm
                ON problem.id = ct_pm.pmId
                   AND ct_pm.ctId = #{ctId}
                   AND ct_pm.deleteFlg = '0'
        WHERE
            problem.deleteFlg = '0'
    </select>
    <select id="checkIfSolvedBefore" resultType="java.lang.Integer">
        select count(*)
          from submission
            where submission.urId = #{urId}
              AND submission.pmId = #{pmId}
              AND submission.deleteFlg='0'
              AND submission.judgeStatus=6
    </select>
    <select id="getProblemToSubmit" resultType="ProblemDTO">
        SELECT
            problem.id,
            problem.name
        FROM problem
            INNER JOIN ct_pm
                ON problem.id = ct_pm.pmId
                   AND ct_pm.ctId = #{ctId}
                   AND ct_pm.isHidden=0
                   AND ct_pm.deleteFlg = '0'
        WHERE
            problem.deleteFlg = '0'
    </select>
    <resultMap id="problem" type="ProblemDTO">
        <id column="pmId" property="id"/>
        <result column="pmCe" property="code"/>
        <result column="pmNe" property="name"/>
        <result column="dif" property="difficulty"/>
        <result column="pub" property="isPublished"/>
        <collection property="lstTag" ofType="TagDTO">
            <id property="id" column="tgId"/>
            <result property="name" column="tgNe"/>
        </collection>
    </resultMap>
</mapper>