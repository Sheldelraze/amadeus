<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.minh.nguyen.mapper.UserMapper">
    <select id="findListUserByFullnameOrHandle" resultType="UserDTO">
        select user.fullname,
        user.handle,
        user.id,
        user.reId
        from user
        where user.deleteFlg = '0'
        <if test="text != null and text.length > 0">
            and (user.handle like concat(#{text},'%')
            or user.fullname like concat(#{text],'%'))
        </if>
    </select>
    <select id="getUserAuthority" resultMap="UserDetail">
        SELECT
            user.id AS urId,
        user.handle AS handle,
        user.password  AS password,
        authority.id AS auyId,
            authority.name AS auyName
        FROM user
        LEFT JOIN role
        ON user.reId = role.id
            LEFT JOIN re_auy
        ON role.id = re_auy.reId
        LEFT JOIN authority
        ON re_auy.auyId = authority.id
        WHERE
            user.handle = #{handle}
            AND user.deleteFlg = '0'
    </select>

    <select id="getLeaderboardInfor" resultMap="leaderboard">
        SELECT
            user.id                AS urId,
            user.fullname          AS urName,
            problem.id             AS pmId,
            problem.name           AS pmName,
            problem.firstSolve     AS firstSolve,
            contest.startTime      AS startTime,
            submission.id          AS snId,
            submission.createTime  AS submitTime,
            submission.judgeStatus AS judgeStatus
        FROM user
            INNER JOIN ur_ct_auy
                ON user.id = ur_ct_auy.urId
                   AND ur_ct_auy.deleteFlg = '0'
                   AND ur_ct_auy.auyId = #{auth_participate_id}
                   AND ur_ct_auy.ctId = #{ctId}
            INNER JOIN contest
                ON ur_ct_auy.ctId = contest.id
            LEFT JOIN ct_pm
                ON ur_ct_auy.ctId = ct_pm.ctId
                   AND ct_pm.isHidden = 0
            LEFT JOIN problem
                ON ct_pm.pmId = problem.id
            LEFT JOIN submission
                ON problem.id = submission.pmId
                   AND user.id = submission.urId
        WHERE user.deleteFlg = '0'
        ORDER BY urId, pmId, submitTime
    </select>

    <select id="findUserForProblemRole" resultMap="userAndRole">
        select user.id as urId,
        user.handle,
        user.fullname,
        role.id as reId,
        role.text as text
        from user
        LEFT JOIN
        role
        on user.reId = role.id
        and role.deleteFlg = '0'
        <where>
            <if test="fullname != null and fullname.length > 0">
                user.fullname like concat('%',#{fullname},'%')
            </if>
            <if test="reId != 0">
                user.reId = #{reId}
            </if>
            <if test="1 == 1">
                user.id not in (
                select ur_pm_auy.urId from ur_pm_auy
                where ur_pm_auy.pmId = #{pmId}
                )
            </if>
        </where>
    </select>

    <select id="findUserForContestRole" resultMap="userAndRole">
        select user.id as urId,
        user.handle,
        user.fullname,
        role.id as reId,
        role.text as text
        from user
        LEFT JOIN
        role
        on user.reId = role.id
        and role.deleteFlg = '0'
        <where>
            <if test="fullname != null and fullname.length > 0">
                user.fullname like concat('%',#{fullname},'%')
            </if>
            <if test="reId != 0">
                user.reId = #{reId}
            </if>
            <if test="1 == 1">
                user.id not in (
                select ur_ct_auy.urId from ur_ct_auy
                where ur_ct_auy.ctId = #{ctId}
                )
            </if>
        </where>
    </select>

    <select id="getListProblemRole" resultMap="userAndRole">
        SELECT
            user.id      AS urId,
            user.handle,
            user.fullname,
            role.id      AS reId,
            role.text    AS text,
            authority.id AS auyId
        FROM ur_pm_auy
            INNER JOIN user
                ON user.id = ur_pm_auy.urId
                   AND user.id != #{urId}
                   AND user.deleteFlg = '0'
            LEFT JOIN role
                ON user.reId = role.id
                   AND role.deleteFlg = '0'
            LEFT JOIN authority
                ON ur_pm_auy.auyId = authority.id
                   AND authority.deleteFlg = '0'
        WHERE ur_pm_auy.pmId = #{pmId}
              AND ur_pm_auy.deleteFlg = '0'
    </select>
    <select id="getListContestRole" resultMap="userAndRole">
        SELECT
            user.id      AS urId,
            user.handle,
            user.fullname,
            role.id      AS reId,
            role.text    AS text,
            authority.id AS auyId
        FROM ur_ct_auy
            INNER JOIN user
                ON user.id = ur_ct_auy.urId
                   AND user.id != #{urId}
                   AND user.deleteFlg = '0'
            LEFT JOIN role
                ON user.reId = role.id
                   AND role.deleteFlg = '0'
            LEFT JOIN authority
                ON ur_ct_auy.auyId = authority.id
                   AND authority.deleteFlg = '0'
        WHERE ur_ct_auy.ctId = #{ctId}
              AND ur_ct_auy.deleteFlg = '0'
    </select>
    <resultMap id="userAndRole" type="UserDTO">
        <id column="urId" property="id"/>
        <result column="handle" property="handle"/>
        <result column="fullname" property="fullname"/>
        <association property="role" javaType="RoleDTO">
            <id column="reId" property="id"/>
            <result column="text" property="text"/>
        </association>
        <collection property="lstAuthority" ofType="AuthorityDTO">
            <id column="auyId" property="id"/>
        </collection>
    </resultMap>
    <resultMap id="leaderboard" type="UserDTO">
        <id column="urId" property="id"/>
        <result column="urName" property="fullname"/>
        <result column="startTime" property="contestStartTime"/>
        <collection property="lstProblem" ofType="ProblemDTO">
            <id column="pmId" property="id"/>
            <result column="pmName" property="name"/>
            <result column="firstSolve" property="firstSolveTime"/>
            <collection property="lstSubmission" ofType="SubmissionDTO">
                <id column="snId" property="id"/>
                <result column="submitTime" property="createTime"/>
                <result column="judgeStatus" property="judgeStatus"/>
            </collection>
        </collection>
    </resultMap>
    <resultMap id="UserDetail" type="UserDTO">
        <id column="urId" property="id"/>
        <result column="handle" property="handle"/>
        <result column="password" property="password"/>
        <collection property="lstAuthority" ofType="AuthorityDTO">
            <id column="auyId" property="id"/>
            <result column="auyName" property="name"/>
        </collection>
    </resultMap>
</mapper>